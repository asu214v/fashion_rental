<div class="menu-header" style="position: static; padding-bottom: 0;">
    <h3 style="margin: 0; font-size: 1.2em;">絞り込み検索</h3>
</div>

<form method="get" action="{% url 'hamburger:index' %}" id="searchForm">

    <div class="form-section">
        <label for="id_keyword">キーワード検索:</label>
        <input type="text" name="keyword" id="id_keyword" 
               placeholder="商品名や説明文" 
               value="{{ params.keyword|default_if_none:'' }}">
    </div>

    <div class="form-section">
        <label>性別:</label>
        <div class="selection-buttons-container">
            {% for choice in SEX_CHOICES %}
                <button type="button" name="sex" value="{{ choice }}" 
                        class="selection-button-small {% if params.sex == choice or not params.sex and choice == 'すべて' %}selected{% endif %}">
                    {{ choice }}
                </button>
            {% endfor %}
        </div>
    </div>

    <div class="form-section">
        <label>タイプ:</label>
        <div class="selection-buttons-container">
            {% for choice in TYPE_CHOICES %}
                <button type="button" name="type" value="{{ choice }}" 
                        class="selection-button-small {% if params.type == choice or not params.type and choice == 'すべて' %}selected{% endif %}">
                    {{ choice }}
                </button>
            {% endfor %}
        </div>
    </div>

    <div class="form-section price-section">
        <label>価格帯:</label>
        <div style="display: flex; align-items: center;">
            <label for="min_price" style="flex-shrink: 0; width: auto; margin-right: 5px;">¥</label>
            <input type="number" name="min_price" id="min_price" 
                   placeholder="下限 (0)" 
                   value="{{ params.min_price|default_if_none:'' }}" 
                   style="width: 50%;">
            <span style="margin: 0 10px;">~</span>
            <label for="max_price" style="flex-shrink: 0; width: auto; margin-right: 5px;">¥</label>
            <input type="number" name="max_price" id="max_price" 
                   placeholder="上限なし" 
                   value="{{ params.max_price|default_if_none:'' }}" 
                   style="width: 50%;">
        </div>
        </div>

    <div class="form-section">
        <label for="id_size">サイズ:</label>
        <input type="text" name="size" id="id_size" 
               placeholder="例: M, 27cm" 
               value="{{ params.size|default_if_none:'' }}">
    </div>

    <div class="form-section">
        <label for="id_brand">ブランド:</label>
        <input type="text" name="brand" id="id_brand" 
               placeholder="ブランド名" 
               value="{{ params.brand|default_if_none:'' }}">
    </div>

    <div class="form-section color-selection-grid">
        <label>色:</label>
        <div class="color-grid-container">
            {% for color_name, color_code in COLOR_MAP.items %}
                <button type="button" name="color" value="{{ color_name }}" 
                        class="color-option-btn {% if params.color == color_name or not params.color and color_name == 'すべて' %}selected{% endif %}"
                        style="background-color: {{ color_code }}; color: {% if color_name == 'ホワイト' or color_name == 'イエロー' %}black{% else %}white{% endif %}; border: {% if color_name == 'ホワイト' or color_name == 'イエロー' or color_name == 'すべて' %}1px solid #ccc{% else %}none{% endif %};">
                    {{ color_name }}
                </button>
            {% endfor %}
        </div>
    </div>

    <div class="form-actions">
        <button type="submit" class="search-submit-btn">検索</button>
        <button type="reset" class="search-reset-btn" onclick="window.location.href='{% url 'hamburger:index' %}'">リセット</button>
    </div>
</form>

<div class="search-history-section">
    <h4 style="margin-bottom: 5px;">検索履歴</h4>
    {% if search_history %}
        {% for term in search_history %}
            <a href="{% url 'hamburger:index' %}?keyword={{ term }}" class="history-tag">
                {{ term }}
            </a>
        {% endfor %}
    {% else %}
        <p class="no-history">履歴はありません。</p>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('searchForm');
    
    // 性別、タイプ、色ボタンのクリックハンドラ
    form.querySelectorAll('.selection-button-small, .color-option-btn').forEach(button => {
        button.addEventListener('click', function() {
            const groupName = this.getAttribute('name');
            const currentValue = this.getAttribute('value');
            
            // 現在の選択を解除
            form.querySelectorAll(`button[name="${groupName}"]`).forEach(btn => {
                btn.classList.remove('selected');
            });

            // 新しい選択を適用
            this.classList.add('selected');
            
            // Hidden Inputを作成または更新してフォームに含める
            let hiddenInput = form.querySelector(`input[name="${groupName}"]`);
            if (!hiddenInput) {
                hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = groupName;
                form.appendChild(hiddenInput);
            }
            hiddenInput.value = currentValue;
        });
    });

    // ページロード時に hidden input を初期化 (ブラウザの戻るボタン対策)
    form.querySelectorAll('.selected').forEach(selectedBtn => {
        const groupName = selectedBtn.getAttribute('name');
        const currentValue = selectedBtn.getAttribute('value');
        
        let hiddenInput = form.querySelector(`input[name="${groupName}"]`);
        if (!hiddenInput) {
            hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = groupName;
            form.appendChild(hiddenInput);
        }
        hiddenInput.value = currentValue;
    });

    // リセットボタンのデフォルト動作を停止
    form.querySelector('.search-reset-btn').addEventListener('click', (e) => {
        e.preventDefault();
        window.location.href = "{% url 'hamburger:index' %}";
    });
});
</script>